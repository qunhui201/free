name: Sync scripts to Cloudflare KV

on:
  push:
    paths:
      - 'test/**'          # scripts 目录有改动才触发
  workflow_dispatch:          # 也可以手动点 Run workflow 触发
  schedule:
    - cron: '0 3 * * *'       # 每天北京时间 11:00 自动同步一次（可改）

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4

      - name: 上传所有 scripts 文件到 Cloudflare KV
        env:
          CF_ACCOUNT_ID: ff1dc991c5a62e449eadbf9dc83c1f95          # ← 改这里（概览页能看到）
          CF_NAMESPACE_ID: 0cf40b4892e945d699c659a6d9ebad2d           # ← 改这里（KV 页面点进去能看到）
          CF_API_TOKEN: ${{ secrets.CF_KV_TOKEN }}       # ← 我们下面加的 Secret
        run: |
          # 安装 curl 和 jq
          sudo apt-get update && sudo apt-get install -y curl jq

          # 遍历 scripts 目录下所有文件（支持多层子目录）
          find scripts -type f | while read file; do
            key="${file#test/}"        # 去掉 test/ 前缀 → 就是 KV 的 key
            value=$(cat "$file" | sed 's/"/\\"/g' | tr '\n' '\f')  # 转义双引号

            echo "正在上传: $key"

            # Cloudflare KV 单键写入 API（最稳定）
            curl -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$CF_NAMESPACE_ID/values/$key" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" >/dev/null 2>&1

            echo "✓ $key 上传成功"
          done

          echo "全部文件同步完成！"
